<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Request Queue with Email Link</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 30px; }
    button, select, textarea, input { margin: 5px; padding: 8px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 10px; text-align: left; }
    th { background-color: #f4f4f4; }
    textarea, input[type="text"] { width: 100%; resize: vertical; }

    .expired { background-color: #ffe5e5; }
    .warning { background-color: #fffacc; }
    .processed { background-color: #e5ffe5; }
  </style>
</head>
<body>

  <h2>Request Queue</h2>

  <label for="requestInput"><strong>Request:</strong></label><br>
  <textarea id="requestInput" placeholder="Enter request data"></textarea><br>

  <label for="emailInput"><strong>Email Link:</strong></label><br>
  <input type="text" id="emailInput" placeholder="Enter email link (optional)"><br>

  <select id="timeSelect">
    <option value="24">1 Business Day</option>
    <option value="48">2 Business Days</option>
    <option value="72">3 Business Days</option>
    <option value="86">4 Business Days</option>
  </select>

  <button onclick="addRequest()">Add Request</button>

  <h3>Queue:</h3>
  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>Request</th>
        <th>Email Link</th>
        <th>Time Left</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="queueTableBody"></tbody>
  </table>

<script>
  let queue = [];
  const STORAGE_KEY = "requestQueue";

  function saveQueue() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(queue));
  }

  function loadQueue() {
    const data = localStorage.getItem(STORAGE_KEY);
    if (data) {
      queue = JSON.parse(data);
      queue.forEach(req => {
        req.timestamp = new Date(req.timestamp);
        req.deadline = new Date(req.deadline);
      });
    }
  }

  function addRequest() {
    const requestInput = document.getElementById('requestInput');
    const emailInput = document.getElementById('emailInput');
    const timeSelect = document.getElementById('timeSelect');

    const requestData = requestInput.value.trim();
    const emailLink = emailInput.value.trim();
    const hours = parseInt(timeSelect.value);
    if (requestData === "" || isNaN(hours)) return;

    const timestamp = new Date();
    const deadline = new Date(timestamp.getTime() + hours * 60 * 60 * 1000);

    queue.push({ 
      data: requestData, 
      email: emailLink,
      timestamp, 
      deadline, 
      businessHours: hours,
      status: "active",
      frozenTimeLeft: null
    });

    requestInput.value = "";
    emailInput.value = "";
    saveQueue();
    updateQueueDisplay();
  }

  function deleteRequest(index) {
    if (index >= 0 && index < queue.length) {
      queue.splice(index, 1);
      saveQueue();
      updateQueueDisplay();
    }
  }

  function processRequest(index) {
    if (index >= 0 && index < queue.length) {
      const req = queue[index];
      req.status = "processed";
      const now = new Date();
      req.frozenTimeLeft = Math.max(0, req.deadline - now);
      saveQueue();
      updateQueueDisplay();
    }
  }

  function markNeedingRevisions(index) {
    if (index >= 0 && index < queue.length) {
      const req = queue[index];
      req.status = "needsRevisions";
      const now = new Date();
      req.frozenTimeLeft = Math.max(0, req.deadline - now);
      saveQueue();
      updateQueueDisplay();
    }
  }

  function restoreRequest(index) {
    const selectEl = document.getElementById(`restoreTime-${index}`);
    const newHours = parseInt(selectEl.value);
    if (isNaN(newHours)) return;

    const req = queue[index];
    const newTimestamp = new Date();
    const newDeadline = new Date(newTimestamp.getTime() + newHours * 60 * 60 * 1000);

    req.timestamp = newTimestamp;
    req.deadline = newDeadline;
    req.businessHours = newHours;
    req.status = "active";
    req.frozenTimeLeft = null;

    saveQueue();
    updateQueueDisplay();
  }

  function formatTime(ms) {
    if (ms <= 0) return "Expired";
    const days = Math.floor(ms / (1000 * 60 * 60 * 24));
    const hours = Math.floor((ms % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const minutes = Math.floor((ms % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((ms % (1000 * 60)) / 1000);
    return `${days}d ${hours}h ${minutes}m ${seconds}s`;
  }

  function updateQueueDisplay() {
    const tbody = document.getElementById("queueTableBody");
    tbody.innerHTML = "";

    const now = new Date();
    const activeRequests = queue.filter(req => req.status === "active")
                                .sort((a, b) => a.deadline - b.deadline);
    const processedRequests = queue.filter(req => req.status === "processed" || req.status === "needsRevisions");

    const sortedQueue = [...activeRequests, ...processedRequests];

    sortedQueue.forEach((req, displayIndex) => {
      const actualIndex = queue.indexOf(req);
      let timeLeftMs;

      if ((req.status === "processed" || req.status === "needsRevisions") && req.frozenTimeLeft !== null) {
        timeLeftMs = req.frozenTimeLeft;
      } else {
        timeLeftMs = req.deadline - now;
      }

      const isExpired = timeLeftMs <= 0;
      const isWarning = timeLeftMs > 0 && timeLeftMs <= 12 * 60 * 60 * 1000;

      const row = document.createElement("tr");
      if (req.status === "processed" || req.status === "needsRevisions") row.classList.add("processed");
      else if (isExpired) row.classList.add("expired");
      else if (isWarning) row.classList.add("warning");

      const emailHTML = req.email
        ? `<a href="${req.email}" target="_blank">${req.email}</a>`
        : `<em>No link</em>`;

      let timeDisplay = formatTime(timeLeftMs);
      if (req.status === "processed") {
        timeDisplay += " (Processed)";
      } else if (req.status === "needsRevisions") {
        timeDisplay += " (Needing Revisions)";
      }

      const actionHTML =
        req.status === "processed" || req.status === "needsRevisions"
          ? `
            <select id="restoreTime-${actualIndex}">
              <option value="">Select Time</option>
              <option value="24">1 Business Day</option>
              <option value="48">2 Business Days</option>
              <option value="72">3 Business Days</option>
              <option value="96">4 Business Days</option>
            </select>
            <button onclick="restoreRequest(${actualIndex})">Restore to Queue</button>
            ${req.status === "processed" ? `<button onclick="markNeedingRevisions(${actualIndex})">Needing Revisions</button>` : ""}
            <button onclick="deleteRequest(${actualIndex})">Delete</button>
          `
          : `
            <button onclick="processRequest(${actualIndex})">Process</button>
            <button onclick="deleteRequest(${actualIndex})">Delete</button>
          `;

      row.innerHTML = `
        <td>${displayIndex + 1}</td>
        <td>${req.data.replace(/\n/g, "<br>")}</td>
        <td>${emailHTML}</td>
        <td>${timeDisplay}</td>
        <td>${actionHTML}</td>
      `;
      tbody.appendChild(row);
    });
  }

  loadQueue();
  updateQueueDisplay();
  setInterval(updateQueueDisplay, 1000);
</script>



</body>
</html>
