<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Request Queue with Status</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 30px; }
        button, select, textarea, input { margin: 5px; padding: 8px; font-size: 14px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ccc; padding: 10px; text-align: left; vertical-align: top; }
        th { background-color: #f4f4f4; }
        textarea, input[type="text"] { width: 100%; box-sizing: border-box; resize: vertical; }
        .status-expired { background-color: #ffe5e5; font-weight: bold; }
        .status-warning { background-color: #fffacc; }
        .status-processed { background-color: #e5ffe5; opacity: 0.7; }
        .status-clientRevisions { background-color: #e5f7ff; }
        .status-active { font-weight: bold; }
    </style>
</head>
<body>

    <h2>CTC TCP Request Queue</h2>

    <label for="requestInput"><strong>Request:</strong></label><br>
    <textarea id="requestInput" placeholder="Enter request data" rows="3"></textarea><br>

    <label for="emailInput"><strong>Email Link:</strong></label><br>
    <input type="text" id="emailInput" placeholder="Enter email link (optional)"><br>

    <select id="timeSelect">
        <option value="24">1 Business Day</option>
        <option value="48">2 Business Days</option>
        <option value="72">3 Business Days</option>
        <option value="96">4 Business Days</option>
        <option value="110">5 Business Days</option>
    </select>

    <button onclick="addRequest()">Add Request</button>

    <h3>Queue:</h3>
    <table>
        <thead>
            <tr>
                <th>#</th>
                <th>Request</th>
                <th>Email Link</th>
                <th>Status</th>
                <th>Time Left</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="queueTableBody"></tbody>
    </table>

<script>
    let queue = [];
    const STORAGE_KEY = "requestQueue";

    function saveQueue() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(queue));
    }

    function loadQueue() {
        const data = localStorage.getItem(STORAGE_KEY);
        if (data) {
            queue = JSON.parse(data).map(req => ({
                ...req,
                timestamp: new Date(req.timestamp),
                deadline: new Date(req.deadline),
            }));
        }
    }

    function addRequest() {
        const requestInput = document.getElementById('requestInput');
        const emailInput = document.getElementById('emailInput');
        const timeSelect = document.getElementById('timeSelect');

        const requestData = requestInput.value.trim();
        const emailLink = emailInput.value.trim();
        const hours = parseInt(timeSelect.value);
        if (requestData === "" || isNaN(hours)) return;

        const timestamp = new Date();
        const deadline = new Date(timestamp.getTime() + hours * 60 * 60 * 1000);

        queue.push({
            id: `req_${Date.now()}`,
            data: requestData,
            email: emailLink,
            timestamp,
            deadline,
            businessHours: hours,
            status: "active",
            frozenTimeLeft: null
        });

        requestInput.value = "";
        emailInput.value = "";
        saveQueue();
        renderQueue();
    }
    
    function findReqIndexById(id) {
        return queue.findIndex(req => req.id === id);
    }

    function deleteRequest(id) {
        const index = findReqIndexById(id);
        if (index !== -1) {
            queue.splice(index, 1);
            saveQueue();
            renderQueue();
        }
    }

    function updateRequestStatus(id, newStatus) {
        const index = findReqIndexById(id);
        if (index !== -1) {
            const req = queue[index];
            const now = new Date();

            if (newStatus === 'needsRevisions') {
                const hoursStr = prompt("Enter new fulfillment time in hours (e.g., 24 for 1 business day):", "24");
                const hours = parseInt(hoursStr);
                if (isNaN(hours) || hours <= 0) {
                    alert("Invalid time. Request not updated.");
                    return;
                }
                req.timestamp = now;
                req.deadline = new Date(now.getTime() + hours * 60 * 60 * 1000);
                req.businessHours = hours;
                req.status = "clientRevisions";
                req.frozenTimeLeft = null;
            } 
            else if (newStatus === 'active') {
                const hoursStr = prompt("Enter new fulfillment time in hours (e.g., 24 for 1 business day):", req.businessHours || "24");
                const hours = parseInt(hoursStr);
                if (isNaN(hours) || hours <= 0) {
                    alert("Invalid time. Request not updated.");
                    return;
                }
                req.timestamp = now;
                req.deadline = new Date(now.getTime() + hours * 60 * 60 * 1000);
                req.businessHours = hours;
                req.frozenTimeLeft = null;
                req.status = 'active';
            }
            else if (newStatus !== 'active') {
                req.status = newStatus;
                req.frozenTimeLeft = Math.max(0, req.deadline.getTime() - now.getTime());
            }

            saveQueue();
            renderQueue();
        }
    }

    function formatTime(ms) {
        if (ms <= 0) return "Expired";
        const days = Math.floor(ms / (1000 * 60 * 60 * 24));
        const hours = Math.floor((ms % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((ms % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((ms % (1000 * 60)) / 1000);
        return `${days}d ${hours}h ${minutes}m ${seconds}s`;
    }

    function renderQueue() {
        const tbody = document.getElementById("queueTableBody");
        tbody.innerHTML = ""; 

        const sortedQueue = [...queue].sort((a, b) => {
            const isActive = s => s === 'active' || s === 'clientRevisions';
            if (isActive(a.status) && !isActive(b.status)) return -1;
            if (!isActive(a.status) && isActive(b.status)) return 1;
            if (isActive(a.status) && isActive(b.status)) return a.deadline - b.deadline;
            return 0;
        });

        sortedQueue.forEach((req, displayIndex) => {
            const row = document.createElement("tr");
            row.id = req.id;

            const emailHTML = req.email ? `<a href="${req.email}" target="_blank">${req.email}</a>` : `<em>No link</em>`;
            
            const actionsHTML = {
                active: `
                    <button onclick="updateRequestStatus('${req.id}', 'processed')">Process</button>
                    <button onclick="deleteRequest('${req.id}')">Delete</button>
                `,
                processed: `
                    <button onclick="updateRequestStatus('${req.id}', 'active')">Re-activate</button>
                    <button onclick="updateRequestStatus('${req.id}', 'needsRevisions')">Needs Revisions</button>
                    <button onclick="deleteRequest('${req.id}')">Delete</button>
                `,
                clientRevisions: `
                    <button onclick="updateRequestStatus('${req.id}', 'processed')">Process</button>
                    <button onclick="deleteRequest('${req.id}')">Delete</button>
                `
            };
            
            row.innerHTML = `
                <td>${displayIndex + 1}</td>
                <td>${req.data.replace(/\n/g, "<br>")}</td>
                <td>${emailHTML}</td>
                <td class="status-cell"></td>
                <td class="timer-cell"></td>
                <td class="actions-cell">${actionsHTML[req.status] || ''}</td>
            `;
            tbody.appendChild(row);
        });

        updateTimers(); 
    }

    function updateTimers() {
        const now = new Date();
        queue.forEach(req => {
            const row = document.getElementById(req.id);
            if (!row) return;

            let timeLeftMs;
            let statusClass = `status-${req.status}`;
            let timeDisplay;
            
            const formattedStatus = 
                req.status === 'clientRevisions' ? 'Client Requested Revisions' :
                req.status.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());

            if (req.status === 'active' || req.status === 'clientRevisions') {
                timeLeftMs = req.deadline.getTime() - now.getTime();
                if (timeLeftMs <= 0) {
                    statusClass = 'status-expired';
                } else if (timeLeftMs <= 12 * 60 * 60 * 1000) {
                    statusClass = 'status-warning';
                }
                timeDisplay = formatTime(timeLeftMs);
            } else {
                timeLeftMs = req.frozenTimeLeft;
                timeDisplay = formatTime(timeLeftMs);
            }

            row.className = statusClass;
            const timerCell = row.querySelector('.timer-cell');
            const statusCell = row.querySelector('.status-cell');

            if (timerCell) timerCell.textContent = timeDisplay;
            if (statusCell) statusCell.textContent = formattedStatus;
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadQueue();
        renderQueue();
        setInterval(updateTimers, 1000);
    });
</script>

</body>
</html>
